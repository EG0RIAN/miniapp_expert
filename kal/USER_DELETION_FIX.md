# Исправление проблемы удаления пользователей в Django Admin

## Проблема
Пользователи не могли удалить других пользователей в Django Admin. Особенно проблематично было удаление администраторов (суперпользователей).

## Причина
1. В методе `delete_model` была проверка `if obj.is_superuser`, которая блокировала удаление всех суперпользователей
2. У некоторых пользователей были `None` значения для `is_staff` и `is_superuser`, что вызывало проблемы

## Решение

### 1. Изменена логика удаления в `apps/users/admin.py`

**Было:**
- Блокировалось удаление всех суперпользователей
- В массовом удалении исключались все суперпользователи

**Стало:**
- Разрешено удаление всех пользователей, кроме самого себя (текущего пользователя)
- Проверка: `if obj.pk == request.user.pk` - нельзя удалить самого себя
- Улучшена обработка ошибок с логированием

### 2. Исправлены None значения

Запущен скрипт для исправления пользователей с `is_staff=None` и `is_superuser=None`:
- Все `None` значения заменены на `False`
- Это позволяет корректно работать с пользователями

### 3. Улучшена обработка ошибок

- Добавлено логирование ошибок
- Сохранение email пользователя перед удалением (для сообщения об успехе)
- Более информативные сообщения об ошибках

## Изменения в коде

### `delete_model(self, request, obj)`
```python
def delete_model(self, request, obj):
    """Кастомное удаление с обработкой связанных данных"""
    from django.contrib import messages
    try:
        # Проверяем, не пытаемся ли удалить текущего пользователя
        if obj.pk == request.user.pk:
            messages.error(request, 'Нельзя удалить самого себя!')
            return
        
        # Сохраняем email для сообщения
        user_email = obj.email
        
        # Удаляем пользователя
        obj.delete()
        messages.success(request, f'Пользователь {user_email} успешно удален.')
    except Exception as e:
        # Обработка ошибок с логированием
        ...
```

### `delete_queryset(self, request, queryset)`
```python
def delete_queryset(self, request, queryset):
    """Массовое удаление"""
    # Исключаем текущего пользователя
    queryset = queryset.exclude(pk=request.user.pk)
    ...
```

## Результат

✅ Теперь можно удалять всех пользователей, включая администраторов
✅ Нельзя удалить самого себя (защита от случайного удаления)
✅ Исправлены None значения в базе данных
✅ Улучшена обработка ошибок
✅ Добавлено логирование для отладки

## Использование

1. Войдите в Django Admin
2. Перейдите в раздел "Пользователи"
3. Выберите пользователя для удаления
4. Нажмите "Удалить"
5. Подтвердите удаление

**Примечание:** Вы не сможете удалить самого себя, даже если попытаетесь выбрать себя в списке для массового удаления.

## Связанные данные

При удалении пользователя связанные данные обрабатываются следующим образом:
- **CASCADE**: Удаляются связанные записи (платежные методы, мандаты, рефералы, выплаты и т.д.)
- **SET NULL**: Обнуляются ссылки на пользователя (заказы, платежи, транзакции, записи аудита)

Все это настраивается в моделях через `on_delete=models.CASCADE` или `on_delete=models.SET_NULL`.

