#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฑััััะพะณะพ ะดะตะฟะปะพั MiniAppExpert
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh

SERVER="root@195.2.73.224"
LANDING_DIR="/var/www/miniapp.expert"
APP_DIR="/var/www/demoapp"

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  ๐ MiniAppExpert Deploy Script          โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ัะตัะฒะตัั
echo "๐ก ะัะพะฒะตัะบะฐ ะฟะพะดะบะปััะตะฝะธั ะบ ัะตัะฒะตัั..."
if ! ssh -o ConnectTimeout=5 $SERVER "echo 'OK'" > /dev/null 2>&1; then
    echo "โ ะะต ัะดะฐะปะพัั ะฟะพะดะบะปััะธัััั ะบ ัะตัะฒะตัั!"
    exit 1
fi
echo "โ ะะพะดะบะปััะตะฝะธะต ััะฟะตัะฝะพ"
echo ""

# ะะตะฟะปะพะน ะปะตะฝะดะธะฝะณะฐ
echo "๐ ะะตะฟะปะพะน ะปะตะฝะดะธะฝะณะฐ (miniapp.expert)..."
if scp -r site/* $SERVER:$LANDING_DIR/ > /dev/null 2>&1; then
    echo "โ ะะตะฝะดะธะฝะณ ะพะฑะฝะพะฒะปะตะฝ"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะดะตะฟะปะพะต ะปะตะฝะดะธะฝะณะฐ"
    exit 1
fi
echo ""

# ะะธะปะด ะฟัะธะปะพะถะตะฝะธั
echo "๐ฆ ะกะฑะพัะบะฐ Mini App..."
if npm run build > /dev/null 2>&1; then
    echo "โ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ัะฑะพัะบะต"
    exit 1
fi
echo ""

# ะะตะฟะปะพะน ะฟัะธะปะพะถะตะฝะธั
echo "๐ฑ ะะตะฟะปะพะน Mini App (demoapp.miniapp.expert)..."
if scp -r dist/* $SERVER:$APP_DIR/ > /dev/null 2>&1; then
    echo "โ Mini App ะพะฑะฝะพะฒะปะตะฝ"
else
    echo "โ ะัะธะฑะบะฐ ะฟัะธ ะดะตะฟะปะพะต ะฟัะธะปะพะถะตะฝะธั"
    exit 1
fi
echo ""

# ะะตัะตะทะฐะณััะทะบะฐ Nginx
echo "๐ ะะตัะตะทะฐะณััะทะบะฐ Nginx..."
if ssh $SERVER "nginx -t && systemctl reload nginx" > /dev/null 2>&1; then
    echo "โ Nginx ะฟะตัะตะทะฐะณััะถะตะฝ"
else
    echo "โ๏ธ  ะัะตะดัะฟัะตะถะดะตะฝะธะต: ะะต ัะดะฐะปะพัั ะฟะตัะตะทะฐะณััะทะธัั Nginx"
fi
echo ""

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ  โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!              โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะะตะฝะดะธะฝะณ:      https://miniapp.expert"
echo "๐ ะะตะฝะดะธะฝะณ (www): https://www.miniapp.expert"
echo "๐ฑ Mini App:     https://demoapp.miniapp.expert"
echo ""
echo "๐ก ะัะพะฒะตัััะต ัะฐะฑะพัั ัะฐะนัะพะฒ ะฒ ะฑัะฐัะทะตัะต"
echo ""

