<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Оплата успешна! | MiniAppExpert</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        secondary: '#0088CC',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen flex items-center justify-center px-6">
        <div class="max-w-2xl w-full">
            <!-- Success Card -->
            <div class="bg-white rounded-3xl shadow-2xl p-12 text-center">
                <!-- Success Icon -->
                <div class="w-24 h-24 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>

                <h1 class="text-3xl font-bold text-gray-900 mb-4 flex items-center gap-3">
                    <i data-lucide="check-circle" class="w-8 h-8 text-green-500"></i>
                    <span>Оплата успешна!</span>
                </h1>
                <p class="text-gray-600 mb-8 text-lg">Ваш заказ принят в обработку</p>

                <!-- Order Info -->
                <div class="bg-gray-50 rounded-2xl p-6 mb-8 text-left">
                    <div class="text-sm font-semibold text-gray-500 mb-4">Номер заказа:</div>
                    <div class="font-mono text-xl font-bold text-primary mb-6" id="orderId">ORDER_123456</div>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600">Продукт:</span>
                            <span class="font-semibold" id="productName">Загрузка...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Сумма:</span>
                            <span class="font-semibold" id="orderAmount">Загрузка...</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600">Статус:</span>
                            <span class="font-semibold text-green-600 flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i>
                                <span>Оплачено</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- What's Next -->
                <div class="bg-gradient-to-br from-primary/10 to-secondary/10 border-2 border-primary rounded-2xl p-6 mb-8 text-left">
                    <h2 class="font-bold text-lg mb-4 flex items-center gap-2">
                        <i data-lucide="mail" class="w-5 h-5 text-primary"></i>
                        <span>Что дальше?</span>
                    </h2>
                    <div class="space-y-3 text-sm">
                        <div class="flex items-start space-x-3">
                            <i data-lucide="clock" class="w-6 h-6 text-primary flex-shrink-0 mt-0.5"></i>
                            <div>
                                <div class="font-semibold mb-1">Через 15 минут</div>
                                <div class="text-gray-600">Мы отправим на ваш email данные для входа в приложение и админ-панель</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i data-lucide="mail" class="w-6 h-6 text-secondary flex-shrink-0 mt-0.5"></i>
                            <div>
                                <div class="font-semibold mb-1">Проверьте почту</div>
                                <div class="text-gray-600">Письмо придет на <span class="font-mono text-primary" id="userEmail">your@email.com</span></div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i data-lucide="user" class="w-6 h-6 text-primary flex-shrink-0 mt-0.5"></i>
                            <div>
                                <div class="font-semibold mb-1">Войдите в личный кабинет</div>
                                <div class="text-gray-600">Все данные дублируются в вашем ЛК</div>
                            </div>
                        </div>
                        <div class="flex items-start space-x-3">
                            <i data-lucide="message-circle" class="w-6 h-6 text-secondary flex-shrink-0 mt-0.5"></i>
                            <div>
                                <div class="font-semibold mb-1">Поддержка 24/7</div>
                                <div class="text-gray-600">Мы всегда на связи в Telegram</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="space-y-3">
                    <a href="/cabinet.html" id="cabinetBtn" class="block w-full bg-primary text-white py-4 rounded-xl font-bold hover:bg-primary/90 transition flex items-center justify-center gap-2">
                        <i data-lucide="user" class="w-5 h-5"></i>
                        <span>Перейти в личный кабинет</span>
                    </a>
                    <a href="/" class="block w-full border-2 border-gray-300 text-gray-700 py-4 rounded-xl font-bold hover:bg-gray-50 transition flex items-center justify-center gap-2">
                        <i data-lucide="home" class="w-5 h-5"></i>
                        <span>Вернуться на главную</span>
                    </a>
                </div>

                <!-- Support -->
                <div class="mt-8 text-sm text-gray-500">
                    Возникли вопросы? <a href="https://t.me/miniappexpert" target="_blank" class="text-primary font-semibold hover:underline">Напишите нам в Telegram</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Get order ID from URL
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('orderId') || params.get('OrderId');
            const paymentId = params.get('PaymentId');
            const status = params.get('Status');
            
            if (orderId) {
                document.getElementById('orderId').textContent = orderId;
            }
            
            // Load order info from API (more reliable than localStorage)
            if (orderId) {
                // Show loading state
                document.getElementById('productName').textContent = 'Загрузка...';
                document.getElementById('orderAmount').textContent = 'Загрузка...';
                
                fetch(`/api/payment/status?orderId=${encodeURIComponent(orderId)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Order data received:', data);
                        if (data.success && data.order) {
                            // Update order ID
                            document.getElementById('orderId').textContent = data.order.orderId;
                            
                            // Update email
                            if (data.order.customerEmail) {
                                document.getElementById('userEmail').textContent = data.order.customerEmail;
                            }
                            
                            // Update product name
                            if (data.order.description) {
                                document.getElementById('productName').textContent = data.order.description;
                            } else {
                                document.getElementById('productName').textContent = 'Загрузка...';
                            }
                            
                            // Update amount
                            if (data.order.amount) {
                                const amount = parseFloat(data.order.amount);
                                document.getElementById('orderAmount').textContent = amount.toLocaleString('ru-RU') + ' ₽';
                            } else {
                                document.getElementById('orderAmount').textContent = 'Загрузка...';
                            }
                            
                            // Если платеж подтвержден и есть токен авторизации, автоматически авторизуем пользователя
                            if (data.authToken && data.user) {
                                localStorage.setItem('userAuth', 'true');
                                localStorage.setItem('userToken', data.authToken);
                                localStorage.setItem('userEmail', data.user.email);
                                localStorage.setItem('userName', data.user.name || data.user.email);
                                
                                console.log('✅ User automatically authorized after payment');
                                
                                // Кнопка уже должна работать, но убедимся что она кликабельна
                                const cabinetBtn = document.getElementById('cabinetBtn');
                                if (cabinetBtn) {
                                    cabinetBtn.style.pointerEvents = 'auto';
                                    cabinetBtn.style.opacity = '1';
                                }
                            } else {
                                // Если токена нет, показываем сообщение что нужно войти
                                console.warn('⚠️ No auth token received. User may need to login manually.');
                                const cabinetBtn = document.getElementById('cabinetBtn');
                                if (cabinetBtn) {
                                    cabinetBtn.onclick = function(e) {
                                        e.preventDefault();
                                        alert('Для доступа в личный кабинет необходимо войти. Вы будете перенаправлены на страницу входа.');
                                        window.location.href = '/login.html?email=' + encodeURIComponent(data.order.customerEmail || '');
                                    };
                                }
                            }
                            
                            // Update order in localStorage if exists
                            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                            const orderIndex = orders.findIndex(o => o.orderId === orderId);
                            if (orderIndex !== -1) {
                                orders[orderIndex].status = 'paid';
                                orders[orderIndex].paymentId = paymentId || data.payment?.paymentId;
                                orders[orderIndex].paidAt = new Date().toISOString();
                                localStorage.setItem('orders', JSON.stringify(orders));
                            }
                        } else {
                            // Fallback to localStorage if API fails
                            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                            const order = orders.find(o => o.orderId === orderId);
                            
                            if (order) {
                                document.getElementById('userEmail').textContent = order.email || 'your@email.com';
                                if (order.product) {
                                    document.getElementById('productName').textContent = order.product;
                                }
                                if (order.amount) {
                                    document.getElementById('orderAmount').textContent = order.amount.toLocaleString('ru-RU') + ' ₽';
                                }
                                order.status = 'paid';
                                order.paymentId = paymentId;
                                order.paidAt = new Date().toISOString();
                                localStorage.setItem('orders', JSON.stringify(orders));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching order:', error);
                        // Fallback to localStorage
                        const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                        const order = orders.find(o => o.orderId === orderId);
                        if (order) {
                            document.getElementById('userEmail').textContent = order.email || 'your@email.com';
                            if (order.product) {
                                document.getElementById('productName').textContent = order.product;
                            }
                            if (order.amount) {
                                document.getElementById('orderAmount').textContent = order.amount.toLocaleString('ru-RU') + ' ₽';
                            }
                        }
                    });
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
    
</body>
</html>

