<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Оплата | MiniAppExpert</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="notification.js"></script>
    <script src="modal.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        secondary: '#0088CC',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="white" stroke="white" stroke-width="2"/>
                    </svg>
                </div>
                <div class="text-xl font-bold text-gray-900">MiniAppExpert</div>
            </a>
            <div class="text-sm text-gray-500">Безопасная оплата</div>
        </div>
    </header>

    <!-- Payment Form -->
    <div class="max-w-4xl mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Order Summary -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="credit-card" class="w-6 h-6"></i>
                        Оплата заказа
                    </h1>

                    <!-- Order Details -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h2 class="font-bold mb-4">Ваш заказ:</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Продукт:</span>
                                <span class="font-semibold" id="productName">Mini App для недвижимости</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Запуск:</span>
                                <span class="font-semibold">15 минут</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="mb-6">
                        <h2 class="font-bold mb-4">Контактные данные:</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold mb-2">Название компании / ФИО *</label>
                                <input type="text" id="companyName" required
                                       class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary outline-none"
                                       placeholder="Название вашей компании или ваше ФИО">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Email *</label>
                                <input type="email" id="paymentEmail" required
                                       class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary outline-none"
                                       placeholder="your@email.com">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold mb-2">Телефон *</label>
                                <input type="tel" id="paymentPhone" required
                                       class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary outline-none"
                                       placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>
                    </div>

                    <!-- Subscription Agreement -->
                    <div class="mb-4">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" id="subscriptionAgree" class="w-5 h-5 text-primary rounded border-2 border-gray-300 mt-0.5 mr-3 flex-shrink-0">
                            <div class="text-sm">
                                <span class="text-gray-900">
                                    Я согласен с <a href="/subscription-terms.html" target="_blank" class="text-primary font-semibold underline hover:text-primary/80">условиями подписки</a> *
                                </span>
                            </div>
                        </label>
                    </div>

                    <!-- Personal Data Agreement -->
                    <div class="mb-6">
                        <label class="flex items-start cursor-pointer">
                            <input type="checkbox" id="personalDataAgree" class="w-5 h-5 text-primary rounded border-2 border-gray-300 mt-0.5 mr-3 flex-shrink-0">
                            <div class="text-sm">
                                <span class="text-gray-900">
                                    Я согласен на <a href="/privacy.html" target="_blank" class="text-primary font-semibold underline hover:text-primary/80">обработку персональных данных</a> *
                                </span>
                            </div>
                        </label>
                    </div>

                    <!-- Payment Button -->
                    <button onclick="processPayment()" class="w-full bg-gradient-to-r from-primary to-secondary text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transition flex items-center justify-center gap-2">
                        <i data-lucide="credit-card" class="w-5 h-5"></i>
                        Перейти к оплате
                    </button>

                    <!-- Security Info -->
                    <div class="mt-6 flex items-center justify-center space-x-4 text-sm text-gray-500">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
                            </svg>
                            Безопасная оплата
                        </div>
                        <div class="flex items-center">
                            <img src="https://acdn.tinkoff.ru/static/documents/logo.svg" alt="T-Bank" class="h-4 mr-1">
                            T-Bank
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
                    <h2 class="font-bold mb-4">Итого:</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600" id="productNameSummary">Подписка</span>
                            <span class="font-semibold" id="productPriceSummary">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Админ-панель</span>
                            <span class="font-semibold text-green-600">Включено</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Поддержка 24/7</span>
                            <span class="font-semibold text-green-600">Включено</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Инструкция</span>
                            <span class="font-semibold text-green-600">Включено</span>
                        </div>
                    </div>

                    <div class="border-t pt-4 mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-bold">К оплате:</span>
                            <div class="text-2xl font-bold text-primary" id="totalAmount">-</div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2" id="subscriptionInfo"></div>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-xl p-4 text-sm">
                        <div class="font-semibold text-green-700 mb-3 flex items-center gap-2">
                            <i data-lucide="check-circle" class="w-4 h-4"></i>
                            После оплаты вы получите:
                        </div>
                        <ul class="text-green-600 space-y-2 text-xs">
                            <li class="flex items-center gap-2">
                                <i data-lucide="link" class="w-3 h-3 flex-shrink-0"></i>
                                <span>Ссылку на ваше приложение</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="key" class="w-3 h-3 flex-shrink-0"></i>
                                <span>Пароль для админ-панели</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="book-open" class="w-3 h-3 flex-shrink-0"></i>
                                <span>Подробную инструкцию</span>
                            </li>
                            <li class="flex items-center gap-2">
                                <i data-lucide="headphones" class="w-3 h-3 flex-shrink-0"></i>
                                <span>Доступ к поддержке 24/7</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <script src="tbank-payment.js"></script>
    <script>
        // Debug mode
        const DEBUG = false;
        
        // Get order data from URL or localStorage
        function getOrderData() {
            const params = new URLSearchParams(window.location.search);
            const savedOrder = localStorage.getItem('pendingOrder');
            
            // Get data from URL params (always present)
            const urlData = {
                product: params.get('product') || 'Mini App для недвижимости',
                price: parseInt(params.get('price')) || 150000,
                companyName: params.get('company') || '',
                email: params.get('email') || '',
                phone: params.get('phone') || ''
            };
            
            // If we have saved order data, merge it with URL params
            // URL params take priority for price, product
            if (savedOrder) {
                try {
                    const parsedOrder = JSON.parse(savedOrder);
                    return {
                        ...parsedOrder,
                        product: urlData.product,
                        price: urlData.price,
                        companyName: parsedOrder.companyName || urlData.companyName,
                        email: parsedOrder.email || urlData.email,
                        phone: parsedOrder.phone || urlData.phone
                    };
                } catch (e) {
                    console.error('Error parsing saved order:', e);
                    return urlData;
                }
            }
            
            return urlData;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const order = getOrderData();
                
                if (DEBUG) console.log('Order data:', order);
                
                // Fill order info
                document.getElementById('productName').textContent = order.product;
                document.getElementById('totalAmount').textContent = order.price.toLocaleString('ru-RU') + ' ₽';
                
                // Fill summary in right column
                document.getElementById('productNameSummary').textContent = order.product;
                document.getElementById('productPriceSummary').textContent = order.price.toLocaleString('ru-RU') + ' ₽';
                
                // Check if it's a subscription (monthly)
                const urlParams = new URLSearchParams(window.location.search);
                const isSubscription = urlParams.get('subscription') === 'monthly';
                
                if (isSubscription) {
                    document.getElementById('subscriptionInfo').textContent = 'Ежемесячный платёж';
                }
                
                // Don't pre-fill contact fields - user must enter manually
            } catch (error) {
                console.error('Init error:', error);
                notifyError('Ошибка инициализации страницы. Попробуйте обновить страницу.');
            }
        });

        // Process payment - SIMPLIFIED VERSION
        async function processPayment() {
            try {
                const companyName = document.getElementById('companyName').value.trim();
                const email = document.getElementById('paymentEmail').value.trim();
                const phone = document.getElementById('paymentPhone').value.trim();
                const subscriptionAgree = document.getElementById('subscriptionAgree').checked;
                
                if (!companyName || !email || !phone) {
                    notifyError('Заполните все обязательные поля (Компания, Email, Телефон)');
                    return;
                }
                
                const personalDataAgree = document.getElementById('personalDataAgree').checked;
                
                if (!subscriptionAgree) {
                    notifyWarning('Для продолжения необходимо согласиться с условиями подписки');
                    document.getElementById('subscriptionAgree').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                if (!personalDataAgree) {
                    notifyWarning('Для продолжения необходимо согласиться на обработку персональных данных');
                    document.getElementById('personalDataAgree').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                const order = getOrderData();
                
                if (DEBUG) {
                    console.log('Processing payment...', {
                        email,
                        phone,
                        amount: order.price
                    });
                }
                
                // Generate order ID
                const orderId = 'ORDER_' + Date.now();
                
                // Prepare payment data for T-Bank API
                const paymentData = {
                    amount: order.price,
                    orderId: orderId,
                    description: order.product,
                    email: email,
                    phone: phone,
                    name: companyName
                };
                
                if (DEBUG) console.log('Creating payment via API:', paymentData);
                
                // Call our backend API to create T-Bank payment
                const response = await fetch('https://miniapp.expert/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(paymentData)
                });
                
                const result = await response.json();
                
                if (DEBUG) console.log('API response:', result);
                
                if (!result.success) {
                    throw new Error(result.message || 'Ошибка создания платежа');
                }
                
                // Save order to localStorage with pending status
                const orderData = {
                    orderId: orderId,
                    product: order.product,
                    amount: order.price,
                    companyName: companyName,
                    email: email,
                    phone: phone,
                    subscriptionAgreed: true,
                    subscriptionAgreedAt: new Date().toISOString(),
                    status: 'pending',
                    paymentId: result.paymentId,
                    paymentUrl: result.paymentUrl,
                    createdAt: new Date().toISOString()
                };
                
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.push(orderData);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                if (DEBUG) console.log('Order saved with pending status:', orderData);
                
                // Open T-Bank payment page
                notifyInfo('Переходим к оплате...\n\nНомер заказа: ' + orderId + '\nСумма: ' + order.price.toLocaleString('ru-RU') + ' ₽');
                
                // Redirect to T-Bank payment page after short delay
                setTimeout(() => {
                    window.location.href = result.paymentUrl;
                }, 1500);
                
            } catch (error) {
                console.error('Payment error:', error);
                notifyError('Ошибка: ' + error.message + '\n\nПопробуйте позже или свяжитесь с поддержкой.');
            }
        }

        // Save order
        function saveOrder(paymentData, payment) {
            const orders = JSON.parse(localStorage.getItem('orders') || '[]');
            
            orders.push({
                orderId: paymentData.orderId,
                paymentId: payment.PaymentId,
                product: paymentData.description,
                amount: paymentData.amount,
                email: paymentData.email,
                phone: paymentData.phone,
                status: 'pending',
                createdAt: new Date().toISOString()
            });
            
            localStorage.setItem('orders', JSON.stringify(orders));
        }
        
        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
    </script>
</body>
</html>

