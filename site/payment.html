<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Оплата | MiniAppExpert</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="notification.js"></script>
    <script src="modal.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        secondary: '#0088CC',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white border-b border-gray-200">
        <div class="max-w-4xl mx-auto px-6 py-4 flex items-center justify-between">
            <a href="/" class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M13 2L3 14H12L11 22L21 10H12L13 2Z" fill="white" stroke="white" stroke-width="2"/>
                    </svg>
                </div>
                <div class="text-xl font-bold text-gray-900">MiniAppExpert</div>
            </a>
            <div class="text-sm text-gray-500">Безопасная оплата</div>
        </div>
    </header>

    <!-- Payment Form -->
    <div class="max-w-4xl mx-auto px-6 py-12">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Order Summary -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-lg p-8">
                    <h1 class="text-2xl font-bold mb-6 flex items-center gap-2">
                        <i data-lucide="credit-card" class="w-6 h-6"></i>
                        Оплата заказа
                    </h1>

                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-12">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-600">Загрузка данных заказа...</p>
                    </div>

                    <!-- Order Details -->
                    <div id="orderDetails" class="hidden">
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h2 class="font-bold mb-4">Ваш заказ:</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Продукт:</span>
                                    <span class="font-semibold" id="productName">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Запуск:</span>
                                <span class="font-semibold">15 минут</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="mb-6">
                        <h2 class="font-bold mb-4">Контактные данные:</h2>
                        <div class="space-y-4">
                            <div>
                                    <label class="block text-sm font-semibold mb-2">Название компании / ФИО *</label>
                                    <input type="text" id="companyName" required
                                           class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary outline-none"
                                           placeholder="Название вашей компании или ваше ФИО">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold mb-2">Email *</label>
                                <input type="email" id="paymentEmail" required
                                       class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary outline-none"
                                       placeholder="your@email.com">
                            </div>
                            <div>
                                    <label class="block text-sm font-semibold mb-2">Телефон *</label>
                                <input type="tel" id="paymentPhone" required
                                       class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 focus:border-primary outline-none"
                                       placeholder="+7 (999) 123-45-67">
                            </div>
                        </div>
                    </div>

                        <!-- Subscription Agreement -->
                        <div class="mb-4" id="subscriptionAgreementBlock">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox" id="subscriptionAgree" required
                                       class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                                <span class="ml-3 text-sm text-gray-700">
                                    Я согласен с условиями подписки *
                                    <a href="#" id="subscriptionTermsLink" target="_blank" class="text-primary hover:underline ml-1">(подробнее)</a>
                                </span>
                            </label>
                        </div>

                        <!-- Personal Data Agreement -->
                        <div class="mb-6">
                            <label class="flex items-start cursor-pointer">
                                <input type="checkbox" id="personalDataAgree" required
                                       class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary">
                                <span class="ml-3 text-sm text-gray-700">
                                    Я согласен на обработку персональных данных *
                                    <a href="/privacy.html" target="_blank" class="text-primary hover:underline ml-1" id="privacyLink">(подробнее)</a>
                                </span>
                            </label>
                        </div>

                        <!-- Submit Button -->
                        <button onclick="processPayment()" 
                                class="w-full bg-gradient-to-r from-primary to-secondary text-white py-4 rounded-xl font-bold text-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1">
                            Перейти к оплате
                        </button>
                    </div>

                    <!-- Error State -->
                    <div id="errorState" class="hidden text-center py-12">
                        <div class="text-red-600 mb-4">
                            <i data-lucide="alert-circle" class="w-16 h-16 mx-auto"></i>
                        </div>
                        <h2 class="text-xl font-bold mb-2">Ошибка загрузки заказа</h2>
                        <p class="text-gray-600 mb-4" id="errorMessage"></p>
                        <a href="/" class="text-primary hover:underline">Вернуться на главную</a>
                    </div>
                </div>
            </div>

            <!-- Order Summary Sidebar -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-4">
                    <h2 class="font-bold mb-4">Безопасная оплата</h2>
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="shield-check" class="w-5 h-5 text-green-600"></i>
                        <span class="text-sm text-gray-600">T-Bank</span>
                    </div>

                    <div class="border-t border-gray-200 pt-4 space-y-3">
                        <div class="flex justify-between text-sm" id="subscriptionInfoBlock">
                            <span class="text-gray-600">Подписка -</span>
                            <span class="font-semibold" id="subscriptionInfo">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Админ-панель</span>
                            <span class="font-semibold text-green-600">Включено</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Поддержка 24/7</span>
                            <span class="font-semibold text-green-600">Включено</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-600">Инструкция</span>
                            <span class="font-semibold text-green-600">Включено</span>
                        </div>
                    </div>

                    <div class="border-t border-gray-200 pt-4 mt-4">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold">К оплате:</span>
                            <span class="text-2xl font-bold text-primary" id="totalAmount">-</span>
                        </div>
                    </div>

                    <div class="mt-6 text-xs text-gray-500 space-y-2">
                        <p>После оплаты вы получите:</p>
                        <ul class="list-disc list-inside space-y-1 ml-2">
                            <li>Ссылку на ваше приложение</li>
                            <li>Пароль для админ-панели</li>
                            <li>Подробную инструкцию</li>
                            <li>Доступ к поддержке 24/7</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="tbank-payment.js"></script>
    <script>
        // Debug mode
        const DEBUG = true;
        
        let preOrderId = null;
        let preOrderData = null;

        // Get pre-order ID from URL
        function getPreOrderIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('pre_order_id');
        }

        // Load pre-order data from API
        async function loadPreOrder() {
            const preOrderId = getPreOrderIdFromURL();
            
            if (!preOrderId) {
                showError('Предзаказ не найден. Проверьте ссылку.');
                return;
            }
            
            // Валидация UUID формата
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(preOrderId)) {
                console.error('Invalid UUID format:', preOrderId);
                showError('Неверный формат идентификатора заказа. Проверьте ссылку.');
                return;
            }
            
            try {
                console.log('Loading pre-order:', preOrderId);
                const response = await fetch(`/api/order/pre-order/${preOrderId}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                });
                
                console.log('Response status:', response.status, response.statusText);
                console.log('Response headers:', Object.fromEntries(response.headers.entries()));
                
                // Проверить Content-Type
                const contentType = response.headers.get('content-type') || '';
                const isJson = contentType.includes('application/json');
                
                // Получить текст ответа
                const responseText = await response.text();
                console.log('Response text (first 500 chars):', responseText.substring(0, 500));
                
                let data;
                if (isJson) {
                    try {
                        data = JSON.parse(responseText);
                } catch (e) {
                        console.error('Failed to parse JSON response:', e);
                        showError('Ошибка обработки ответа сервера. Сервер вернул невалидный JSON.');
                        return;
                    }
                } else {
                    // Если ответ не JSON (например, HTML страница ошибки от Django)
                    console.error('Server returned non-JSON response. Content-Type:', contentType);
                    console.error('Response text preview:', responseText.substring(0, 200));
                    
                    // Попробовать извлечь сообщение об ошибке из HTML (если есть)
                    let errorMessage = 'Ошибка загрузки предзаказа.';
                    
                    if (response.status === 404) {
                        errorMessage = 'Предзаказ не найден. Проверьте правильность ссылки или создайте новый заказ.';
                    } else if (response.status === 400) {
                        errorMessage = 'Неверный формат идентификатора заказа или параметры запроса. Проверьте ссылку.';
                    } else if (response.status === 500) {
                        errorMessage = 'Внутренняя ошибка сервера. Попробуйте позже или обратитесь в поддержку.';
                    } else {
                        errorMessage = `Ошибка сервера (код ${response.status}). Обратитесь в поддержку.`;
                    }
                    
                    showError(errorMessage);
                    return;
                }
                
                console.log('Response data:', data);
                
                // Проверить успешность ответа - API может вернуть success: false даже при 200 статусе
                if (data && data.success === false) {
                    const errorMessage = data.message || data.error || data.detail || 'Предзаказ не найден или уже использован.';
                    console.error('Pre-order not found or invalid:', errorMessage);
                    
                    // Определить тип ошибки по сообщению
                    if (errorMessage.includes('not found') || errorMessage.includes('не найден')) {
                        showError('Предзаказ не найден. Проверьте правильность ссылки или создайте новый заказ.');
                    } else if (errorMessage.includes('already used') || errorMessage.includes('уже использован')) {
                        showError('Этот предзаказ уже был использован. Пожалуйста, создайте новый заказ.');
                    } else if (errorMessage.includes('expired') || errorMessage.includes('истек')) {
                        showError('Предзаказ истек. Пожалуйста, создайте новый заказ.');
                    } else {
                        showError(errorMessage);
                    }
                    return;
                }
                
                if (!response.ok) {
                    const errorMessage = data.message || data.error || data.detail || 'Ошибка загрузки предзаказа.';
                    console.error('API returned error status:', response.status, 'Message:', errorMessage);
                    
                    // Обработать сообщения на английском и русском
                    let userMessage = errorMessage;
                    if (errorMessage.includes('not found') || errorMessage.includes('не найден')) {
                        if (errorMessage.includes('already used') || errorMessage.includes('уже использован')) {
                            userMessage = 'Этот предзаказ уже был использован. Пожалуйста, создайте новый заказ.';
                        } else {
                            userMessage = 'Предзаказ не найден. Проверьте правильность ссылки или создайте новый заказ.';
                        }
                    } else if (errorMessage.includes('already used') || errorMessage.includes('уже использован')) {
                        userMessage = 'Этот предзаказ уже был использован. Пожалуйста, создайте новый заказ.';
                    } else if (errorMessage.includes('expired') || errorMessage.includes('истек')) {
                        userMessage = 'Предзаказ истек. Пожалуйста, создайте новый заказ.';
                    }
                    
                    if (response.status === 404) {
                        showError(userMessage);
                    } else if (response.status === 410) {
                        showError(userMessage);
                    } else if (response.status === 400) {
                        showError(userMessage || 'Неверные параметры запроса. Проверьте ссылку.');
                    } else {
                        showError(userMessage || `Ошибка загрузки предзаказа (код ${response.status}).`);
                    }
                    return;
                }
                
                // Проверить успешность ответа
                if (data && (data.success === true || data.product)) {
                    // Если есть product, значит это успешный ответ (может быть без поля success в некоторых версиях API)
                    preOrderData = data;
                    displayPreOrderData(data);
                    // Загрузить документы из API (для актуальных ссылок)
                    await loadDocuments();
                } else {
                    // Ответ не содержит данных о предзаказе
                    const errorMsg = data?.message || data?.error || data?.detail || 'Ошибка загрузки предзаказа.';
                    console.error('Failed to load pre-order:', errorMsg, data);
                    showError(errorMsg || 'Неверные параметры. Проверьте ссылку.');
                }
            } catch (error) {
                console.error('Error loading pre-order:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                
                // Обработать различные типы ошибок
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    showError('Ошибка подключения к серверу. Проверьте интернет-соединение и попробуйте обновить страницу.');
                } else if (error.name === 'SyntaxError') {
                    showError('Ошибка обработки ответа сервера. Попробуйте обновить страницу.');
                } else {
                    showError('Ошибка загрузки предзаказа: ' + (error.message || 'Неизвестная ошибка') + '. Попробуйте обновить страницу.');
                }
            }
        }
        
        // Load documents from API
        async function loadDocuments() {
            try {
                // Загрузить политику конфиденциальности
                const privacyResponse = await fetch('/api/documents/privacy/');
                const privacyResult = await privacyResponse.json();
                if (privacyResult.success && privacyResult.document) {
                    const privacyLink = document.getElementById('privacyLink');
                    if (privacyLink && privacyResult.document.slug) {
                        privacyLink.href = `/document/${privacyResult.document.slug}.html`;
                    }
                }
            } catch (error) {
                console.error('Error loading documents:', error);
                // В случае ошибки оставляем статические ссылки
            }
        }

        // Display pre-order data
        function displayPreOrderData(data) {
            const product = data.product;
            
            // Hide loading, show order details
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('orderDetails').classList.remove('hidden');
            
            // Fill product info
            document.getElementById('productName').textContent = product.name;
            document.getElementById('totalAmount').textContent = parseFloat(product.price).toLocaleString('ru-RU') + ' ₽';
            
            // Show/hide subscription info
            if (product.product_type === 'subscription') {
                document.getElementById('subscriptionAgreementBlock').classList.remove('hidden');
                if (product.subscription_period === 'monthly') {
                    document.getElementById('subscriptionInfo').textContent = 'Ежемесячный платёж';
                } else if (product.subscription_period === 'yearly') {
                    document.getElementById('subscriptionInfo').textContent = 'Годовой платёж';
                }
                
                // Установить ссылку на условия подписки
                const subscriptionTermsLink = document.getElementById('subscriptionTermsLink');
                if (product.subscription_terms && product.subscription_terms.slug) {
                    subscriptionTermsLink.href = `/document/${product.subscription_terms.slug}.html`;
                    subscriptionTermsLink.style.display = 'inline';
                } else {
                    // Если нет конкретных условий для продукта, используем общие
                    subscriptionTermsLink.href = '/subscription-terms.html';
                    subscriptionTermsLink.style.display = 'inline';
                }
            } else {
                document.getElementById('subscriptionAgreementBlock').classList.add('hidden');
                document.getElementById('subscriptionInfoBlock').classList.add('hidden');
            }
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Show error state
        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Check and sign subscription terms if needed
        async function checkAndSignSubscriptionTerms() {
            // Only check if product is subscription
            if (preOrderData?.product?.product_type !== 'subscription') {
                return true; // Not a subscription, no need to sign
            }
            
            try {
                // Check if user is authenticated
                const token = localStorage.getItem('userToken') || localStorage.getItem('authToken') || localStorage.getItem('accessToken');
                if (!token) {
                    // User not authenticated, use checkbox agreement
                    return true;
                }
                
                // Use subscription_terms from product (specific to this product/tariff)
                const productSubscriptionTerms = preOrderData?.product?.subscription_terms;
                if (!productSubscriptionTerms || !productSubscriptionTerms.id) {
                    // No specific subscription terms for this product, use checkbox agreement
                    return true;
                }
                
                // Check document status for this specific document
                const response = await fetch('/api/client/documents/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`,
                    },
                    credentials: 'same-origin',
                });
                
                if (!response.ok) {
                    // If API fails, use checkbox agreement
                    return true;
                }
                
                const result = await response.json();
                if (!result.success) {
                    return true;
                }
                
                // Find if this specific document needs to be signed
                const documentsToSign = result.data.documents_to_sign || [];
                const subscriptionTermsDoc = documentsToSign.find(doc => 
                    doc.document_type === 'subscription_terms' && 
                    doc.id === productSubscriptionTerms.id &&
                    !doc.is_signed
                );
                
                if (!subscriptionTermsDoc) {
                    // Document already signed or not required
                    return true;
                }
                
                // Show modal for signing with product-specific document
                return await showSubscriptionTermsModal(subscriptionTermsDoc);
            } catch (error) {
                console.error('Error checking subscription terms:', error);
                // On error, allow to proceed with checkbox
                return true;
            }
        }
        
        // Show modal for subscription terms signing
        async function showSubscriptionTermsModal(doc) {
            return new Promise((resolve) => {
                const docUrl = doc.slug ? `/document/${doc.slug}.html` : '/subscription-terms.html';
                
                const modalHtml = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <h3 class="text-xl font-bold text-gray-900 mb-2">Условия подписки</h3>
                            <p class="text-sm text-gray-600 mb-4">
                                Для оформления подписки необходимо ознакомиться и принять условия.
                            </p>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <a 
                                href="${docUrl}" 
                                target="_blank"
                                class="inline-flex items-center gap-2 text-primary hover:text-primary/80 font-semibold text-sm"
                            >
                                <i data-lucide="external-link" class="w-4 h-4"></i>
                                <span>Открыть полный текст документа</span>
                            </a>
                        </div>
                        
                        <label class="flex items-start gap-3 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="subscriptionTermsModalCheckbox"
                                class="mt-1 w-5 h-5 text-primary border-gray-300 rounded focus:ring-primary"
                            >
                            <span class="text-sm text-gray-700">
                                Я ознакомился и принимаю условия <strong>подписки</strong>
                            </span>
                        </label>
                    </div>
                `;
                
                showModal({
                    title: 'Принятие условий подписки',
                    html: modalHtml,
                    type: 'info',
                    confirmText: 'Принять и продолжить',
                    cancelText: 'Отмена',
                    onConfirm: async () => {
                        const checkbox = document.getElementById('subscriptionTermsModalCheckbox');
                        if (!checkbox || !checkbox.checked) {
                            notifyError('Пожалуйста, подтвердите согласие с условиями подписки');
                            resolve(false);
                            return;
                        }
                        
                        // Sign document
                        try {
                            const token = localStorage.getItem('userToken') || localStorage.getItem('authToken') || localStorage.getItem('accessToken');
                            if (!token) {
                                notifyError('Необходима авторизация для подписания документа');
                                resolve(false);
                                return;
                            }
                            
                            // Use document_id from doc (for subscription_terms with different documents per product)
                            const body = doc.id ? { document_id: doc.id } : {};
                            
                            const signResponse = await fetch(`/api/client/documents/accept/subscription_terms/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Accept': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                },
                                credentials: 'same-origin',
                                body: Object.keys(body).length > 0 ? JSON.stringify(body) : undefined,
                            });
                            
                            if (signResponse.ok) {
                                const signResult = await signResponse.json();
                                if (signResult.success) {
                                    notifySuccess('Условия подписки приняты');
                                    resolve(true);
                                } else {
                                    notifyError(signResult.message || 'Ошибка при подписании документа');
                                    resolve(false);
                                }
                        } else {
                                const errorData = await signResponse.json().catch(() => ({}));
                                notifyError(errorData.message || 'Ошибка при подписании документа');
                                resolve(false);
                            }
                        } catch (error) {
                            console.error('Error signing subscription terms:', error);
                            notifyError('Ошибка при подписании документа');
                            resolve(false);
                        }
                    },
                    onCancel: () => {
                        resolve(false);
                    }
                });
                
                // Re-initialize icons
                if (typeof lucide !== 'undefined') {
                    setTimeout(() => lucide.createIcons(), 100);
                }
            });
        }
        
        // Process payment
        async function processPayment() {
            try {
                const companyName = document.getElementById('companyName').value.trim();
                const email = document.getElementById('paymentEmail').value.trim();
                const phone = document.getElementById('paymentPhone').value.trim();
                
                if (!companyName || !email || !phone) {
                    notifyError('Заполните все обязательные поля (Компания, Email, Телефон)');
                    return;
                }
                
                const subscriptionAgree = document.getElementById('subscriptionAgree')?.checked || false;
                const personalDataAgree = document.getElementById('personalDataAgree').checked;
                
                if (!personalDataAgree) {
                    notifyWarning('Для продолжения необходимо согласиться на обработку персональных данных');
                    document.getElementById('personalDataAgree').scrollIntoView({ behavior: 'smooth', block: 'center' });
                    return;
                }
                
                // Check and sign subscription terms if needed (for authenticated users)
                if (preOrderData?.product?.product_type === 'subscription') {
                    const subscriptionTermsSigned = await checkAndSignSubscriptionTerms();
                    if (!subscriptionTermsSigned) {
                        // User cancelled subscription terms acceptance
                        return;
                    }
                    
                    // Also check UI checkbox for non-authenticated users or if API check failed
                    if (!subscriptionAgree) {
                        notifyWarning('Для продолжения необходимо согласиться с условиями подписки');
                        document.getElementById('subscriptionAgree').scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }
                }
                
                const preOrderId = getPreOrderIdFromURL();
                if (!preOrderId) {
                    notifyError('Предзаказ не найден');
                    return;
                }
                
                if (DEBUG) {
                    console.log('Processing payment...', {
                        pre_order_id: preOrderId,
                        email,
                        phone,
                        name: companyName,
                        subscription_agreed: subscriptionAgree
                    });
                }
                
                // Create payment
                const response = await fetch('https://miniapp.expert/api/payment/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    credentials: 'include',  // Для CORS
                    body: JSON.stringify({
                        pre_order_id: preOrderId,
                        email: email,
                        phone: phone,
                        name: companyName,
                        subscription_agreed: subscriptionAgree,
                    }),
                });
                
                const result = await response.json();
                
                if (result.success && result.paymentUrl) {
                    // Redirect to payment page
                    window.location.href = result.paymentUrl;
                } else {
                    notifyError(result.message || 'Ошибка создания платежа');
                }
            } catch (error) {
                console.error('Payment error:', error);
                notifyError('Ошибка обработки платежа: ' + error.message);
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadPreOrder();
        });
    </script>
</body>
</html>
