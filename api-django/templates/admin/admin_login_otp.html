{% extends "admin/login.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}
<style>
    .login-form {
        max-width: 400px;
        margin: 0 auto;
    }
    .otp-input {
        font-size: 24px;
        letter-spacing: 8px;
        text-align: center;
        padding: 15px;
        border: 2px solid #ddd;
        border-radius: 5px;
        width: 100%;
        margin: 20px 0;
    }
    .otp-input:focus {
        border-color: #417690;
        outline: none;
    }
    .resend-link {
        text-align: center;
        margin-top: 10px;
    }
    .resend-link a {
        color: #417690;
        text-decoration: none;
    }
    .resend-link a:hover {
        text-decoration: underline;
    }
    .step-indicator {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
    }
    .step-indicator span {
        display: inline-block;
        width: 30px;
        height: 30px;
        line-height: 30px;
        border-radius: 50%;
        background: #ddd;
        color: #666;
        margin: 0 10px;
    }
    .step-indicator span.active {
        background: #417690;
        color: white;
    }
    .messages {
        margin: 20px 0;
    }
    .messages ul {
        list-style: none;
        padding: 0;
    }
    .messages li {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
    }
    .messages .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .messages .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .messages .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }
</style>
{% endblock %}

{% block content %}
<div class="login-form">
    {% if messages %}
    <div class="messages">
        <ul>
            {% for message in messages %}
            <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {% if step == 'login' or not step %}
    <!-- Шаг 1: Ввод логина и пароля -->
    <div class="step-indicator">
        <span class="active">1</span>
        <span>2</span>
    </div>
    <h1>Вход в админ-панель</h1>
    <p>Введите ваш email и пароль для начала входа</p>
    
    <form method="post" action="{% url 'admin:login' %}">
        {% csrf_token %}
        <input type="hidden" name="step" value="login">
        
        <div class="form-row">
            <label for="id_username">Email:</label>
            <input type="email" name="username" id="id_username" required autofocus>
        </div>
        
        <div class="form-row">
            <label for="id_password">Пароль:</label>
            <input type="password" name="password" id="id_password" required>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="Войти">
        </div>
    </form>
    
    {% elif step == 'otp' %}
    <!-- Шаг 2: Ввод OTP кода из email -->
    <div class="step-indicator">
        <span class="active">1</span>
        <span class="active">2</span>
    </div>
    <h1>Введите код подтверждения</h1>
    <p>Код отправлен на email: <strong>{{ user_email }}</strong></p>
    <p style="color: #666; font-size: 14px;">Код действителен в течение 10 минут</p>
    
    <form method="post" action="{% url 'admin:login' %}">
        {% csrf_token %}
        <input type="hidden" name="step" value="otp">
        
        <div class="form-row">
            <label for="id_otp_code">Код подтверждения:</label>
            <input type="text" name="otp_code" id="id_otp_code" class="otp-input" maxlength="6" pattern="[0-9]{6}" required autofocus placeholder="000000">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Введите 6-значный код из письма</p>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="Подтвердить">
        </div>
        
        <div class="resend-link">
            <form method="post" action="{% url 'admin:resend_otp' %}" style="display: inline;">
                {% csrf_token %}
                <a href="#" onclick="this.parentElement.submit(); return false;">Отправить код повторно</a>
            </form>
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'admin:login' %}" style="color: #666; text-decoration: none;">← Вернуться к вводу логина</a>
        </div>
    </form>
    
    {% elif step == 'totp' %}
    <!-- Шаг 2: Ввод TOTP кода из Google Authenticator -->
    <div class="step-indicator">
        <span class="active">1</span>
        <span class="active">2</span>
    </div>
    <h1>Введите код из Google Authenticator</h1>
    <p>Откройте приложение Google Authenticator и введите 6-значный код</p>
    <p style="color: #666; font-size: 14px;">Пользователь: <strong>{{ user_email }}</strong></p>
    
    <form method="post" action="{% url 'admin:login' %}">
        {% csrf_token %}
        <input type="hidden" name="step" value="totp">
        
        <div class="form-row">
            <label for="id_otp_code">Код из Google Authenticator:</label>
            <input type="text" name="otp_code" id="id_otp_code" class="otp-input" maxlength="6" pattern="[0-9]{6}" required autofocus placeholder="000000">
            <p style="font-size: 12px; color: #666; margin-top: 5px;">Введите 6-значный код из приложения</p>
        </div>
        
        <div class="submit-row">
            <input type="submit" value="Подтвердить">
        </div>
        
        <div style="text-align: center; margin-top: 20px;">
            <a href="{% url 'admin:login' %}" style="color: #666; text-decoration: none;">← Вернуться к вводу логина</a>
        </div>
    </form>
    {% endif %}
</div>

<script>
    // Автоматический фокус и ввод только цифр для OTP
    document.addEventListener('DOMContentLoaded', function() {
        const otpInput = document.getElementById('id_otp_code');
        if (otpInput) {
            otpInput.addEventListener('input', function(e) {
                // Разрешаем только цифры
                this.value = this.value.replace(/[^0-9]/g, '');
                // Ограничиваем длину до 6 символов
                if (this.value.length > 6) {
                    this.value = this.value.slice(0, 6);
                }
            });
            
            // Автоматическая отправка формы при вводе 6 цифр
            otpInput.addEventListener('input', function(e) {
                if (this.value.length === 6) {
                    // Небольшая задержка перед отправкой для удобства пользователя
                    setTimeout(function() {
                        otpInput.form.submit();
                    }, 300);
                }
            });
        }
    });
</script>
{% endblock %}

